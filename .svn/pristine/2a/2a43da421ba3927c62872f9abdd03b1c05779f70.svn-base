package com.evergrande.hdmp.usertags.hbase;

import org.apache.hadoop.conf.Configuration;
import org.apache.hadoop.hbase.HBaseConfiguration;
import org.apache.hadoop.hbase.HConstants;
import org.apache.hadoop.hbase.master.HMaster;
import org.apache.hadoop.hbase.master.HMasterCommandLine;
import org.apache.hadoop.hbase.zookeeper.MiniZooKeeperCluster;
import org.apache.hadoop.util.ToolRunner;
import org.junit.Ignore;

import java.io.File;
import java.net.URL;

/**
 * @author Changhua, Wu
 *         Created on: 2/17/16,2:18 PM
 */

@Ignore
public class HBaseServer {

    public static final String   HBASE_UNIT_TEST_DIR = "./target/hbase-unit-test-dir";

    public static final String   ZK_UNIT_TEST_DIR    = "./target/zookeeperData";

    Thread  hMasterThread;

    public static void deleteRecursive(File[] files) {
        if (files == null)
            return;
        for (File f : files) {
            if (f.isDirectory()) {
                deleteRecursive(f.listFiles());
            }
            f.delete();
        }
    }


    public static void main(String[] args) throws Exception {
        new HBaseServer().start();
    }

    public void start() throws Exception {
        File hbaseFile = new File( HBASE_UNIT_TEST_DIR );
        deleteRecursive(hbaseFile.listFiles());

        File zkFile = new File( ZK_UNIT_TEST_DIR );
        deleteRecursive(zkFile.listFiles());

        Runnable hMasterRun = new Runnable() {
            @Override
            public void run() {
                Configuration conf = HBaseConfiguration.create();
                URL url = ClassLoader.getSystemResource("usertags/hbase-site.xml");
                conf.addResource(url);

                HMasterCommandLine hMasterCommandLine = new HMasterCommandLine( HMaster.class );

                try {
                    ToolRunner.run( conf, hMasterCommandLine, new String[]{"start", "--localRegionServers=1"} );
                } catch (Exception e) {
                    e.printStackTrace();
                }

                //HMaster.main(new String[]{"start"});
            }
        };

        hMasterThread = new Thread( hMasterRun );
        hMasterThread.start();
        Thread.sleep(200);
    }


    public void stop() {

        if(hMasterThread != null) {
            hMasterThread.interrupt();
        }
    }


}
